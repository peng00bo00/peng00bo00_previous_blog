---
layout: article
title: PBRT读书笔记04-Sampling and Reconstruction
tags: ["PBRT", "Rendering", "CG"]
key: PBRT-04
aside:
  toc: true
sidebar:
  nav: PBRT
---

> 这个系列是[Physically Based Rendering: From Theory To Implementation](https://pbr-book.org/)的读书笔记，本节主要介绍采样理论的相关内容。
<!--more-->

## Sampling Theory

在渲染的过程中我们需要对连续的函数进行采样来获得离散的数字图像。对连续信号进行采样的相关理论可以参考在CV课程中介绍过的[频域分析](/2021/08/31/OMSCS-CV-NOTES-03.html)的相关内容，这里主要介绍图像渲染时的**反走样(anti-aliasing)**相关技术。

反走样最直接的方法是提高采样的频率。根据采样定律，只要采样的频率大于信号最大频率的2倍就可以避免走样的问题。然而这种方法在实践中一般是行不通的，这是因为图形学中连续信号都不是**有限带宽(band limited)**的，理论上需要无限的采样率才能够重建出原始信号。因此需要一些其它的方法来解决渲染时的走样问题。

### Sources of Aliasing in Rendering

在渲染中，走样的主要因素来自于场景中的几何。当场景中的物体投影到成像平面上时，物体的边缘会引入**阶跃函数(step function)**，使得我们无法通过有限的采样率来重建出这样的突变。除此之外，场景中的小物体也会导致整体图像的走样：如果物体小到低于采样的间隔，那在物体运动的情况下它会反复地在图像上消失又出现。走样另一个常见的原因是物体的材质和纹理，如果采样的频率低于纹理变化的频率同样会导致走样的问题。

显然我们无法从根源上去除这些导致走样的因素，因此各种反走样技术的核心在于减轻走样在视觉上的影响。

### Antialiasing Techniques

在渲染中常用的反走样计算可以分为三类：**非均匀采样(nonuniform sampling)**、**自适应采样(adaptive sampling)**和**预滤波(prefiltering)**。

#### Nonuniform Sampling

尽管原始信号是无限带宽的，理论上任意有限的采样率都无法完美解决走样的问题，但我们可以通过合理地设置采样率来减轻走样对视觉的影响。非均匀采样的思想是使用一个随机数来对采样频率进行扰动：

$$
\sum_{i=-\infty}^\infty \delta \bigg(x - (i + \frac{1}{2} - \xi) T \bigg)
$$

其中$\xi$为(0, 1)区间上的随机数。显然这样仍然无法避免走样的问题，但使用非均匀采样可以把规则的**伪影(artifacts)**转换成人眼不敏感的噪声。这样尽管走样的问题仍然存在，渲染出的图像却更加符合人的认知。

#### Adaptive Sampling

自适应采样的思想是对图像中不同的区域采用不同的采样频率：对于信号变化剧烈的区域，我们可以使用更高的采样频率从而减轻走样的问题。显然自适应采样的难点在于如何识别出图像中哪些区域有高频的信号，因此在实践中直接使用自适应采样的方法比较少见。

#### Prefiltering

预滤波的思想是在对信号进行重建前首先进行滤波来去除高频成分，这样就可以保证对滤波后的信号进行采样不会出现走样的问题。尽管对图像进行滤波往往会造成图像的模糊，但对人眼来说模糊的图像也要比走样要容易接受得多。

## Low-Discrepancy Sequence

在渲染中我们往往需要对[0, 1)<sup>n</sup>区间进行采样，其中最基本的采样方法是生成[0, 1)区间上的均匀随机数。显然随机数的"质量"对于渲染后的最终结果有着重要的影响，实际上如果使用"高质量"的随机数我们只需要少量的样本就可以渲染出不错的图像，从而大大提升了渲染的效率。要描述随机数的"质量"则需要引入**差异(discrepancy)**的概念。

"差异"可以理解为样本在[0, 1)<sup>n</sup>空间中分布的均匀程度。我们可以在空间中划分出一个区域，然后比较区域中样本占总体的比例与区域体积的大小，它们的差值作为该区域中随机样本的"差异"。以下图为例，在灰色区域中的样本比例为0.25，区域面积为0.09，因此该区域的"差异"为0.16。

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Sampling_and_Reconstruction/Box%20discrepancy.svg" width="30%">
</div>

整个[0, 1)<sup>n</sup>空间上的"差异"可以定义为所有可行划分的"差异"的最大值：

$$
D_N (B, P) = \sup_{b \in B} \bigg\vert \frac{ \# \{ x_i \in b \} }{N}  - V(b) \bigg\vert
$$

"差异"越小，样本在空间中的分布越均匀。同时不难发现"差异"实际上描述了使用概率估计区域$b$的体积与它实际体积的差值，因此"差异"也可以理解为区域$b$体积估计值与真实值的最大误差。除此之外，我们还可以把区域$b$的一角固定在原点，这种情况下的"差异"记为$D_N^* (B, P)$。

在很多情况下我们可以解析地计算样本分布的"差异"。以一维情况为例，假设$N$个样本均匀分布在区间[0, 1)上：

$$
x_i = \frac{i}{N}
$$

此时这些样本的"差异"为：

$$
D_N^* (B, P) = \frac{1}{N}
$$

我们可以将这些样本稍加移动，从而得到更低的"差异"：

$$
x_i = \frac{i - \frac{1}{2}}{N}
$$

$$
D_N^* (B, P) = \frac{1}{2 N}
$$

实际上对于一维的情况，任意分布样本"差异"的理论下界为：

$$
D_N^* (B, P) = \frac{1}{2N} + \max_{1 \leq i \leq N} \bigg\vert x_i - \frac{2i-1}{N} \bigg\vert
$$

因此均匀分布的样本具有最小的"差异"，这与我们直观的认知是一致的。

## Stratified Sampling

## The Halton Sampler

## Reference

- [7 Sampling and Reconstruction](https://pbr-book.org/3ed-2018/Sampling_and_Reconstruction)