---
layout: article
title: PBRT读书笔记03-Camera Models
tags: ["PBRT", "Rendering", "CG"]
key: PBRT-03
aside:
  toc: true
sidebar:
  nav: PBRT
---

> 这个系列是[Physically Based Rendering: From Theory To Implementation](https://pbr-book.org/)的读书笔记，本节主要介绍相机模型的相关内容。
<!--more-->

为了生成具有真实感的图像我们需要去模拟相机的成像过程。在PBRT中使用**投影相机模型(projective camera models)**来描述相机的行为，同时为了描述成像过程中物体的位置我们还需要引入3个坐标系：

1. **屏幕空间(screen space)**：屏幕空间定义了渲染生成图像的范围，它的原点位于相机中心且物体的深度被规范化到[0, 1]区间上。
2. **标准化设备坐标(normalized device coordinate, NDC)**：NDC是规范化后的屏幕空间，此时x和y坐标都被规范化到[0, 1]区间上。
3. **光栅空间(raster space)**：光栅空间表示实际图像定义的空间，x和y坐标由图像的分辨率来定义。

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Camera_Models/Camera%20coordinate%20spaces.svg" width="70%">
</div>

在PBRT中使用4×4的转换矩阵来描述不同坐标系之间的变换关系，而在生成图像时则是从相机发射光线并将光线变换到世界坐标系中来进行计算。不同类型的相机定义了不同的坐标变换关系，这就导致了即使位于相同的位置设置不同类型的相机仍会得到不同的渲染结果。

## Orthographic Camera

**正交投影相机(orthographic camera)**是最基本的投影相机模型。正交投影相机在投影时会直接压缩物体的深度，这样的过程可以通过平移和缩放来描述：

$$
P = 
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & \frac{1}{z_\text{far} - z_\text{near}} & -z_\text{near} \\
0 & 0 & 0 & 1 \\
\end{bmatrix}
$$

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Camera_Models/Ortho%20viewing%20volume.svg" width="30%">
</div>

类似地，在生成光线时正交投影相机发出的光线起点位于光栅平面上，而方向则指向z轴正半轴：

```cpp
float OrthographicCamera::GenerateRay(const CameraSample &sample,
                                      Ray *ray) const {
    // Compute raster and camera sample positions
    Point3f pFilm = Point3f(sample.pFilm.x, sample.pFilm.y, 0);
    Point3f pCamera = RasterToCamera(pFilm);
    *ray = Ray(pCamera, Vector3f(0, 0, 1));

    *ray = CameraToWorld(*ray);
    return 1;
}
```

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Camera_Models/Ortho%20generate%20ray.svg" width="70%">
</div>

## Perspective Camera

正交投影相机的缺陷在于它无法表达物体的透视关系，因此更为常用的相机模型是**透视投影相机(perspective camera)**。在透视投影相机中，空间中的物体首先会通过投影变换来获得透视关系：

$$
P = 
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & \frac{z_\text{far}}{z_\text{far} - z_\text{near}} & -\frac{z_\text{far} \cdot z_\text{near}}{z_\text{far} - z_\text{near}} \\
0 & 0 & 1 & 0 \\
\end{bmatrix}
$$

然后在根据给定的**视野(field of view, FoV)**来规范化到NDC上：

$$
P = 
\begin{bmatrix}
\frac{1}{\tan{\frac{\theta}{2}}} & 0 & 0 & 0 \\
0 & \frac{1}{\tan{\frac{\theta}{2}}} & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1 \\
\end{bmatrix}
\times
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & \frac{z_\text{far}}{z_\text{far} - z_\text{near}} & -\frac{z_\text{far} \cdot z_\text{near}}{z_\text{far} - z_\text{near}} \\
0 & 0 & 1 & 0 \\
\end{bmatrix}
$$

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Camera_Models/Perspective%20transformation%20matrix.svg" width="30%">
</div>

透视投影相机在发射光线时，光线起点固定在原点(相机中心)，方向指向光栅平面上的坐标。

```cpp
float PerspectiveCamera::GenerateRay(const CameraSample &sample,
                                     Ray *ray) const {
    // Compute raster and camera sample positions
    Point3f pFilm = Point3f(sample.pFilm.x, sample.pFilm.y, 0);
    Point3f pCamera = RasterToCamera(pFilm);
    *ray = Ray(Point3f(0, 0, 0), Normalize(Vector3f(pCamera)));

    *ray = CameraToWorld(*ray);
    return 1;
}
```

## Thin Lens Model

## Reference

- [6 Camera Models](https://pbr-book.org/3ed-2018/Camera_Models)