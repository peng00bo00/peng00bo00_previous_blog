---
layout: article
title: Analytic Eigensystems for Isotropic Distortion Energies 论文笔记
tags: ["CG", "GAMES301", "Geometry Processing"]
key: GAMES301-16
aside:
  toc: true
sidebar:
  nav: GAMES301
---

> GAMES301-曲面参数化([GAMES 301: Surface Parameterization](http://staff.ustc.edu.cn/~renjiec/GAMES301/index.html))作业2解析与matlab实现。
<!--more-->

[*Analytic Eigensystems for Isotropic Distortion Energies*](http://www.tkim.graphics/EIGENSYSTEMS/AnalyticEigensystems.pdf)是来自Pixar动画工作室的一篇文章。这篇文章本身是用来处理变形体仿真的问题，主要贡献在于使用矩阵的不变量来描述变形能量并且推导了各向同性材料在相应能量下的解析解。除了物理仿真外，这种技术同样可以用来处理曲面参数化的问题。我们可以把初始状态的曲面想象成某种各项同性材料组成的表面，而参数化的过程相当于把这个表面展平并约束到平面上，此时曲面会通过释放变形能来降低自身的几何扭曲。这篇笔记会详细推导相关的理论并记录下我的matlab实现。

<div align=center>
<img src="https://i.imgur.com/IpAGdtr.png" width="80%">
</div>

## Background

### Deformation Gradient

三角形网格的变形可以使用一个线性函数来进行表示。具体来说，在平面上三角形的每一个顶点的位移都是其坐标的线性组合：

$$
\begin{bmatrix}
x \\ y
\end{bmatrix}
=
\begin{bmatrix}
F_{xx} & F_{xy} \\
F_{yx} & F_{xx} \\
\end{bmatrix}

\begin{bmatrix}
\bar{x} \\ \bar{y}
\end{bmatrix}
+
\begin{bmatrix}
t_x \\ t_y
\end{bmatrix}
$$

上式的矩阵形式为：

$$
\mathbf{x} = \mathbf{F} \mathbf{\bar{x}} + \mathbf{t}
$$

其中系数矩阵$\mathbf{F}$即为坐标变换的Jacobian矩阵，也称为**变形梯度(deformation gradient)**，它描述了三角形的旋转、缩放和反射；而向量$\mathbf{t}$则描述了三角形的刚体位移。

<div align=center>
<img src="https://i.imgur.com/dcpNCyD.png" width="50%">
<img src="https://i.imgur.com/XKFSSxL.png" width="50%">
</div>

变形梯度的计算非常简单，我们只需要考虑三角形两条对应边在变形前后的线性变换即可。我们可以以$\mathbf{\bar{x}}_0$作为三角形的局部原点，此时它的两条邻边分别为：

$$
\mathbf{\bar{o}}_1 = \mathbf{\bar{x}}_1 - \mathbf{\bar{x}}_0
$$

$$
\mathbf{\bar{o}}_2 = \mathbf{\bar{x}}_2 - \mathbf{\bar{x}}_0
$$

带入变形梯度$\mathbf{F}$可以得到：

$$
\mathbf{F}
\begin{bmatrix}
\mathbf{\bar{o}}_1 \vert \mathbf{\bar{o}}_2
\end{bmatrix}
=
\begin{bmatrix}
\mathbf{o}_1 \vert \mathbf{o}_2
\end{bmatrix}
$$

$$
\mathbf{F} \mathbf{D}_m = \mathbf{D}_s
$$

因此只需要求解矩阵方程即可：

$$
\mathbf{F} = \mathbf{D}_s \mathbf{D}_m^{-1}
$$

<div align=center>
<img src="https://i.imgur.com/Q59qOZm.png" width="80%">
</div>

计算三角形从初始构形x1到新构形x2的变形梯度(Jacobian矩阵)可以使用如下`findJacobian()`函数实现。

```matlab
function J = findJacobian(x1, x2)
%% Find Jacobian matrix from rest pose x1 to new pose x2
%% each row of x1/x2 is the coordinate of the triangle vertex

Dm = (x1(2:end, :) - x1(1, :))';
Ds = (x2(2:end, :) - x2(1, :))';

%% J * Dm = Ds
J = Ds * matrixInv2x2(Dm);

end
```

### Symmetric Dirichlet Energy

当三角形发生变形时会产生相应的变形能，此时就需要定义相应的能量函数。显然变形能量与三角形的刚体变换无关，因此它应该是只关于变形梯度$\mathbf{F}$的函数，而且与其中的旋转成分无关。这里可以使用**极分解(polar decomposition)**来分离出变形梯度中的旋转部分：

$$
\mathbf{F} = \mathbf{R} \mathbf{S}
$$

上式中矩阵$\mathbf{R}$即为变形梯度的旋转部分，而矩阵$\mathbf{S}$则表示伸缩。极分解的构造非常简单，我们只需要利用矩阵的**奇异值分解(singular value decomposition, SVD)**就可以实现：

$$
\mathbf{F} = \mathbf{U} \mathbf{\Sigma} \mathbf{V}^T
$$

$$
\mathbf{R} = \mathbf{U} \mathbf{V}^T
$$

$$
\mathbf{S} = \mathbf{V} \mathbf{\Sigma} \mathbf{V}^T
$$

容易验证如此定义的极分解满足所需的性质。不过需要注意的是直接利用SVD计算的旋转成分$\mathbf{R}$可能会出现行列式为负的情况，而旋转矩阵一般要求其行列式为1。因此我们需要对标准的SVD进行一定的修改，保证$\mathbf{U}$和$\mathbf{V}$行列式同号：

```matlab
function [U, Sigma, V] = svd_rv(F)
%% rotation-variant SVD

%% standard SVD
[U, Sigma, V] = svd(F);

%% reflection matrix
%% modified for 2D deformation
L = eye(2,2);
L(2,2) = det(U * V');

%% see where to pull the reflection out of
detU = det(U);
detV = det(V);

if (detU < 0 && detV > 0)
    U = U * L;
elseif (detU > 0 && detV < 0)
    V = V * L;
end

%% push the reflection to the diagonal
Sigma = Sigma * L;

end
```

利用`svd_rv()`函数可以非常容易地定义极分解：

```matlab
function [R, S] = polarDecomposition(F)
%% polar decomposition with rotation-variant SVD

%% rotation variant SVD
[U, Sigma, V] = svd_rv(F);

R = U * V';
S = V * Sigma * V';

end
```

分理出旋转后就可以直接使用$\mathbf{S}$矩阵来定义变形能。**对称Dirichlet能量(symmetric Dirichlet energy)**是几何处理中非常流行的能量函数，它是由变形梯度的两个奇异值来定义的：

$$
\begin{aligned}
\Psi_\text{SD}
&= \frac{1}{2} \bigg( \sigma_1^2 + \sigma_2^2 + \frac{1}{\sigma_1^2} + \frac{1}{\sigma_2^2} \bigg) \\
&= \frac{1}{2} (\Vert \mathbf{F} \Vert_F^2 + \Vert \mathbf{F}^{-1} \Vert_F^2) \\
&= \frac{1}{2} (\Vert \mathbf{S} \Vert_F^2 + \Vert \mathbf{S}^{-1} \Vert_F^2)
\end{aligned}
$$

对称Dirichlet能量的特点在于它包含了奇异值的倒数，因此当三角形接近退化时会产生很大的能量作为惩罚项来避免进一步退化。计算对称Dirichlet能量$\Psi_\text{SD}$的代码如下：

```matlab
function E = computeSDEnergy(x1, x2)
%% Symmetric Dirichlet energy from x1 to x2

F = findJacobian(x1, x2);
Finv = matrixInv2x2(F);

E = norm(F, "fro")^2 + norm(Finv, "fro")^2;
E = 0.5*E;

end
```

### Projected Newton Method

变形体会通过最小化自身的变形能来恢复原始形状。从数学上来看这等价于一个最优化过程，因此我们可以通过求解一个最优化问题来计算变形。在几何处理中我们一般会使用二阶优化方法，和基于梯度的一阶方法相比二阶方法收敛更快而且无需手动设置优化步长。二阶方法中最经典的是**牛顿法(Newton's method)**，也称为**Newton-Raphson方法(Newton-Raphson method)**，对于目标函数$f(\mathbf{x})$

### Vec Operator

### Algorithm Framework

## Gradient

## Hessian

## Line Search

## Results

## Reference

- [Analytic Eigensystems for Isotropic Distortion Energies](http://www.tkim.graphics/EIGENSYSTEMS/AnalyticEigensystems.pdf)
- [Analytic Eigensystems for Isotropic Distortion Energies Supplemental Material](http://www.tkim.graphics/EIGENSYSTEMS/AnalyticEigensystemsSupplement.pdf)
- [Dynamic Deformables: Implementation and Production Practicalities](https://www.tkim.graphics/DYNAMIC_DEFORMABLES/)