---
layout: article
title: C++ STL笔记04-std::vector动态数组
tags: ["C++", "STL"]
key: STL-04
clipboard: true
aside:
  toc: true
sidebar:
  nav: STL
---

> 动手实现C++ STL容器。本节介绍std::vector的常见用法和实现。
<!--more-->

## std::vector用法

[std::vector](https://en.cppreference.com/w/cpp/container/vector)是C++标准库中的一个容器，用于动态数组的实现。`std::vector`的特点如下：

- 顺序序列：容器中的元素按照严格的线性顺序排序，可以通过元素在序列中的位置访问对应的元素；
- 动态数组：支持对序列中的任意元素进行快速直接访问，甚至可以通过指针算述进行该操作；提供了在序列末尾相对快速地添加/删除元素的操作；
- 内存分配器：可以使用一个内存分配器对象来动态地处理它的存储需求。

`std::vector`有非常丰富的成员函数，这里只展示一些比较常用的用法：

```cpp
#include <iostream>
#include <vector>

int main()
{
    // 初始化 vector
    std::vector<int> myVector = {1, 2, 3, 4, 5};
    
    // 获取 vector 大小：
    std::cout << "Vector size: " << myVector.size() << std::endl;
    
    // 访问元素
    std::cout << "First element: " << myVector[0] << std::endl;
    
    // 迭代 vector
    for (size_t i=0; i<myVector.size(); ++i) {
        std::cout << myVector[i] << " ";
    }
    
    std::cout << std::endl;
    
    // range-based for循环
    for (int x : myVector) {
        std::cout << x << " ";
    }
    
    std::cout << std::endl;
    
    // 在末尾添加元素
    std::cout << "Add 6 to the end: ";
    myVector.push_back(6);
    
    for (int x : myVector) {
        std::cout << x << " ";
    }
    
    std::cout << std::endl;
    
    // 在指定位置插入元素
    std::cout << "Insert 10 to myVector[2]: ";
    myVector.insert(myVector.begin() + 2, 10);
    
    for (int x : myVector) {
        std::cout << x << " ";
    }
    
    std::cout << std::endl;
    
    // 删除元素
    std::cout << "Remove myVector[3]: ";
    myVector.erase(myVector.begin() + 3);
    
    for (int x : myVector) {
        std::cout << x << " ";
    }
    
    std::cout << std::endl;
    

    return 0;
}
```

运行上面的代码可以得到如下结果：

```
Vector size: 5
First element: 1
1 2 3 4 5 
1 2 3 4 5 
Add 6 to the end: 1 2 3 4 5 6 
Insert 10 to myVector[2]: 1 2 10 3 4 5 6 
Remove myVector[3]: 1 2 10 4 5 6 
```

`std::vector`的其它成员函数及其用法可以参考[官方文档](https://en.cppreference.com/w/cpp/container/vector)。

## Vector实现

接下来我们从零开始实现一个类似于标准库中`std::vector`的动态数组`Vector`。

### 模板定义

`Vector`包含两个模板参数：元素类型`T`以及内存分配器`Alloc`。这里`Alloc`用来管理`Vector`持有的内存，在大多数情况下使用标准库中的`std::allocator`即可。除此之外，`Vector`还需要几个额外的成员变量：

- `m_data`用来指向容器的起点；
- `m_size`用来记录当前数组的大小；
- `m_cap`用来记录容器的容量；
- `m_alloc`用来保存内存分配器`Alloc`。

```cpp
template <class T, class Alloc = std::allocator<T>>
struct Vector {
    T *m_data;
    size_t m_size;
    size_t m_cap;
    [[no_unique_address]] Alloc m_alloc;
}
```

### 构造函数

`Vector`有各种不同的构造函数用来处理相应的情况。首先默认构造函数，此时需要将数组初始化为一个空数组，即`m_data`为空指针并且数组的大小为0。

```cpp
template <class T, class Alloc = std::allocator<T>>
struct Vector {
    ...
    Vector() noexcept {
        m_data = nullptr;
        m_size = 0;
        m_cap  = 0;
    }
}
```

`Vector`的另一种常见使用情况是初始化一个大小为`n`的数组，此时我们需要把数组的大小和容量都初始化为`n`并且对前`n`个元素进行默认初始化。由于我们使用了`m_alloc`来管理内存，申请内存的过程需要通过`m_alloc`来进行实现。

```cpp
template <class T, class Alloc = std::allocator<T>>
struct Vector {
    ...
    explicit Vector(size_t n, Alloc const &alloc = Alloc()) : m_alloc(alloc) {
        m_data = m_alloc.allocate(n);
        m_cap = m_size = n;
        for (size_t i = 0; i != n; i++) {
            std::construct_at(&m_data[i]); // m_data[i] = 0
        }
    }
}
```

注意这里使用了[std::construct_at](https://en.cppreference.com/w/cpp/memory/construct_at)来初始化`m_data`中的元素。此时它会调用`T`类型的默认构造函数来进行初始化，从而避免直接使用`new`来分配内存和调用构造函数时产生的不必要开销。

与之类似的一种情况是使用`val`来初始化数组，这里需要在调用`std::construct_at`时把`val`作为构造函数的参数传进来。

```cpp
template <class T, class Alloc = std::allocator<T>>
struct Vector {
    ...
    Vector(size_t n, T const &val, Alloc const &alloc = Alloc()) : m_alloc(alloc) {
        m_data = m_alloc.allocate(n);
        m_cap = m_size = n;
        for (size_t i = 0; i != n; i++) {
            std::construct_at(&m_data[i], val); // m_data[i] = val
        }
    }
}
```

### 迭代器

### 完整实现

## Reference

- [stl1weekend](https://github.com/parallel101/stl1weekend/tree/main#%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E6%89%80%E6%9C%89stl%E5%AE%B9%E5%99%A8)
- [【C++标准库】自己动手实现vector容器](https://www.bilibili.com/video/BV1V84y127Pi/?spm_id_from=333.788&vd_source=7a2542c6c909b3ee1fab551277360826)