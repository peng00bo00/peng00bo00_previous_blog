---
layout: article
title: PBRT读书笔记05-Reflection Models
tags: ["PBRT", "Rendering", "CG"]
key: PBRT-05
aside:
  toc: true
sidebar:
  nav: PBRT
---

> 这个系列是[Physically Based Rendering: From Theory To Implementation](https://pbr-book.org/)的读书笔记，本节主要介绍反射模型。
<!--more-->

## Basic Terminology

我们能够看到物体的本质原因是物体反射了光，因此反射模型对于渲染出正确的图像至关重要。在[Surface Reflection](/2021/12/19/PBRT-NOTES-02.html#surface-reflection)一节中我们介绍过BRDF的概念，它表示在$\omega_o$方向上反射光与$\omega_i$方向上接收光的比值。除了BRDF外，对于透明材质光线还会出现透射的情况，描述这种现象的函数称为**BTDF**。在PBRT中我们使用**散射(scattering)**将反射和透射统一起来，这样描述光线和材料表明相互作用的函数称为**BSDF**。

### Reflection Categories

首先来考虑反射的情况。在PBRT中我们将反射分成4种不同的类型：**漫反射(diffuse)**、**光泽镜面反射(glossy specular)**、**完美镜面反射(perfect specular)**以及**反向反射(retro-reflective)**。其中漫反射表示物体接收光线后再各个方向上都具有相同的反射；光泽镜面反射表示光线的反射会聚集在一定的范围上；完美镜面反射则更加严格，它表示物体反射的光线只会出现在一个确定的方向上；而反向反射则表示反射的方向与入射方向在一个区域内。现实中的反射现象可以看作以上四种反射类型的组合，它们的示意图如下：

<div align=center>
<img src="https://i.imgur.com/C0wb67G.jpg" width="80%">
</div>

同时还需要注意的是反射材料的方向性。现实生活中大部分材料是**各向同性(isotropic)**的，对于各向同性材料反射只和入射光线与法线的夹角有关，当入射光线绕法线旋转时反射的能量不变；而对于**各项异性(anisotropic)**材料，当入射光线绕法线旋转时反射的能量也会同时发生变化，在渲染时要格外注意。生活中常见的各项异性材料包括拉丝后的金属(brushed metal)、布料等等。

### Geometric Setting

PBRT在考虑反射时会在光线与材料交点的局部坐标系中进行计算，这个局部坐标系称为**着色坐标系(shading coordinate system)**。这样在进行计算时首先会把入射光线放在着色坐标系中并计算反射光线，然后再把反射光线转换到世界坐标系中进行后续的计算。

着色坐标系可以通过三个正交的向量$(\mathbf{s}, \mathbf{t}, \mathbf{n})$来定义，其中$\mathbf{n}$为交点处的法线方向，另外两个方向则是局部坐标系的x轴和y轴。

<div align=center>
<img src="https://pbr-book.org/3ed-2018/BSDF%20coordinate%20system.svg" width="50%">
</div>

在计算方向时我们往往会使用球坐标来代替直角坐标系，此时球面上的方向可以使用两个角度$(\theta, \phi)$来表示。其中$\theta$表示该方向与z轴的夹角，$\phi$则是方向投影后和x轴的夹角。

<div align=center>
<img src="https://pbr-book.org/3ed-2018/BSDF%20theta%20phi%20angles.svg" width="50%">
</div>

还需要注意的是PBRT在计算反射时有一些假定：

1. 入射光线$\omega_i$和反射光线$\omega_o$在计算时都需要进行单位化，而且需要指向物体表面外侧；
2. PBRT中默认法向$\mathbf{n}$指向物体外侧，这样便于判断光线是射入还是射出透射的物体：光线方向与$\mathbf{n}$在同一半球时表示射入，在相反的半球上时表示射出；
3. 求交计算出的坐标系与着色坐标系可能是不同的，在计算凹凸贴图时会修改求交计算的坐标系；
4. BRDF和BTDF不会假定入射光线$\omega_i$和反射光线$\omega_o$在同一半球上。

## Specular Reflection and Transmission

对于完美镜面反射的情况我们可以通过几何光学来表示入射光线和出射光线的关系：

$$
\theta_o = \theta_i
$$

$$
\phi_o = \phi_i + \pi
$$

对于透射的情况，$\phi_t$与$\phi_i$的关系与反射一致，但$\theta_t$则需要满足**折射定律(Snell's law)**：

$$
\eta_i \sin \theta_i = \eta_t \sin \theta_t
$$

其中$\eta$为**折射率(refractive index)**。在通常情况下不同波长的光线具有不同的折射率，这就导致入射光线发生折射时会散射到不同的方向上，这种现象称为**色散(dispersion)**。但是在图形学中一般会忽略这种现象，假定不同波长的光线都具有相同的折射率。

### Fresnel Reflectance

除了方向外我们还需要计算反射和透射光线的能量占入射光线能量的比例。对于反射的情况这个比例由Fresnel方程来描述，它是Maxwell方程组在光滑表面上的解。对于给定的折射率和入射角度，Fresnel方程的解给出了入射光线在两个极化方向上入射光的反射率。在大多数情况下光线的极性不会产生人眼可见的视觉效果，因此在PBRT中我们忽略光的极性直接假设光线不具有极性，这样Fresnel反射可以认为是垂直和平行方向反射率的平方平均值。

在计算Fresnsl方程时需要考虑不同的材料：

1. **电介质(dielectrics)**：电介质是不导电的材料，它们的折射率为实数(一般介于1~3之间)。
2. **导体(conductors)**：导体可以导电，它们的折射率为复数$\bar{\eta} = \eta + \text{i} k$
3. **半导体(Semiconductors)**：在PBRT中不考虑半导体这种材质。

对于实数折射率的情况，反射率计算公式为：

$$
r_\parallel = \frac{\eta_t \cos \theta_i - \eta_i \cos \theta_t}{\eta_t \cos \theta_i + \eta_i \cos \theta_t}
$$

$$
r_\perp = \frac{\eta_i \cos \theta_i - \eta_t \cos \theta_t}{\eta_i \cos \theta_i + \eta_t \cos \theta_t}
$$

$r_\parallel$和$r_\perp$为光线在两个极化方向上的反射率。对于非极性的光线，Fresnel反射率计算公式为：

$$
F_r = \frac{1}{2} (r_\parallel^2 + r_\perp^2)^2
$$

根据能量守恒，电介质的透射率为$1 - F_r$。对于透射的情况还需要计算透射的角度，这可以通过两种介质中的折射率来计算。

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Reflection_Models/BSDF%20angle%20gives%20in%20out.svg" width="50%">
</div>

还需要注意的是当光线从高折射率射向低折射率的介质时，根据折射定律可能会出现$\sin \theta_t \gt 1$的情况。发生这种现象最大的入射角度称为**临界角度(critical angle)**，当入射角度$\theta_i$大于临界角度时所有的入射能量会反射出去，因此这样的现象也称为**全内反射(total internal reflection)**。显然，当发生全内反射时就不再需要求解Fresnel方程来计算反射率了。

对于折射率是复数的情况，一部分入射能量会被材料吸收并转化成热能。此时Fresnel方程会依赖于折射率的虚部$k$，它也称为材料的**吸收系数(absorption coefficient)**。一般情况下我们不需要考虑导体的折射情况，因此对于电介质与导体的交界处的反射有

$$
r_\perp = \frac{a^2 + b^2 - 2a \cos \theta + \cos^2 \theta}{a^2 + b^2 + 2a \cos \theta + \cos^2 \theta}
$$

$$
r_\parallel = r_\perp \frac{\cos^2 \theta (a^2 + b^2) - 2 a \cos \theta \sin^2 \theta + \sin^4 \theta}{\cos^2 \theta (a^2 + b^2) + 2 a \cos \theta \sin^2 \theta + \sin^4 \theta}
$$

$$
a^2 + b^2 = \sqrt{(\eta^2 - k^2 - \sin^2 \theta)^2 + 4 \eta^2 k^2}
$$

其中$\eta + \text{i} k = \bar{\eta}_t / \bar{\eta}_i$为两种介质的相对折射率。

### Specular Reflection

在此基础上我们就可以得到镜面反射的计算公式：

$$
L_o(\omega_o) = \int f_r(\omega_o, \omega_i) L_i(\omega_i) \vert \cos \theta \vert \ d \omega = F_r(\omega_r) L_i(\omega_r)
$$

其中$\omega_r = R(\omega_o, \mathbf{n})$为$\omega_o$经过法线$\mathbf{n}$反射后的方向。我们可以利用$\delta(x)$函数来构造出镜面反射的BRDF：

$$
f_r(\omega_o, \omega_i) = F_r(\omega_r) \frac{\delta (\omega_i - \omega_r)}{\vert \cos \theta_r \vert}
$$

### Specular Transmission

接下来我们通过折射定律来推导镜面折射情况下的BTDF。假设在两种材料的边界上发生折射，材料的折射率分别为$\eta_i$和$\eta_o$，折射部分的能量为$\tau = 1 - F_r(\omega_i)$。这样折射对应的能量通量为：

$$
d \Phi_o = \tau d \Phi_i
$$

因此入射和折射的radiance关系为：

$$
L_o \cos \theta_o \ d A \ d \omega_o = \tau (L_i \cos \theta_i \ d A \ d \omega_i)
$$

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Reflection_Models/Radiance%20change%20at%20refraction.svg" width="40%">
</div>

对折射定律两边同时进行微分可以得到：

$$
\eta_o \cos \theta_o \ d \theta_o = \eta_i \cos \theta_i \ d \theta_i
$$

$$
\frac{\cos \theta_o \ d \theta_o}{\cos \theta_i \ d \theta_i} = \frac{\eta_i}{\eta_o}
$$

整理上面的式子得到：

$$
L_o \eta_i^2 \ d \phi_o = \tau L_i \eta_o^2 \ d \phi_i
$$

由于$\phi_o = \phi_i + \pi$，因此得到$L_o$和$L_i$的关系：

$$
L_o = \tau L_i \frac{\eta_o^2}{\eta_i^2}
$$

这样就得到了镜面折射情况下的BTDF：

$$
f_r(\omega_o, \omega_i) = \frac{\eta_o^2}{\eta_i^2} (1 - F_r(\omega_i)) \frac{\delta (\omega_i - T(\omega_o, \mathbf{n}) )}{\vert \cos \theta_i \vert}
$$

其中$T(\omega_o, \mathbf{n})$为$\omega_o$绕$\mathbf{n}$折射后的方向。

## Lambertian Reflection

## Microfacet Models

## Reference

- [8 Reflection Models](https://pbr-book.org/3ed-2018/Reflection_Models)