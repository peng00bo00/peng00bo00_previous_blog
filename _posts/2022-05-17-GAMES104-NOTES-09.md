---
layout: article
title: GAMES104课程笔记09-Advanced Animation Technology
tags: ["GAMES104", "CG"]
key: GAMES104-09
aside:
  toc: true
sidebar:
  nav: GAMES104
---

> 这个系列是GAMES104-现代游戏引擎：从入门到实践([GAMES 104: Modern Game Engine-Theory and Practice](https://games104.boomingtech.com/en/))的同步课程笔记。本课程会介绍现代游戏引擎所涉及的系统架构、技术点以及引擎系统相关的知识。本节课主要介绍动画系统中的一些前沿技术。
<!--more-->

在上一节课中我们介绍了游戏引擎中动画系统的基本内容。基于上一讲的内容已经可以实现一些简单的动画了，而现代3A游戏会在这些内容的基础上添加更多的细节来实现更加真实的动画效果。

## Animation Blending

基于[DCC流程](/2022/05/11/GAMES104-NOTES-08.html#animation-dcc-process)我们可以获得不同的动画资源，然而这些资源往往是相互独立的，在实际游戏中我们还需要将不同类型的动画混合起来以实现更加自然的运动效果。以角色的跑动为例，人体的跑动包含低速的步行以及高速的跑动两个部分的动画。将两个动画混合起来就可以实现自然的变速效果。

<div align=center>
<img src="https://i.imgur.com/YWYeBeY.png" width="80%">
</div>

要实现动画的混合非常简单，我们只需要对骨骼的姿态进行插值即可。但和上节课介绍的[关键帧插值](2022/05/11/GAMES104-NOTES-08.html#interpolation)不同，在进行动画混合时不仅需要考虑同一组动画关键帧之间的插值，还要考虑不同组动画不同关键帧的插值。

<div align=center>
<img src="https://i.imgur.com/EHVN0nu.png" width="80%">
</div>

计算插值权重也比不是很难，我们可以按照当前角色运动的速度来选择两个相邻动作的关键帧。两个动作的权重即为对速度进行线性插值的权重。

<div align=center>
<img src="https://i.imgur.com/nylXVVz.png" width="80%">
</div>

在进行动画混合时还要考虑时间线上对齐的问题。要使插值后的动作更加自然，我们需要动画师在动画建模时将每个动画都按照无限循环播放的形式进行设计。同时，两组进行混合的动画最好要保证角色具有相同的肢体运动频率。这样可以保证混合后的动画更加自然，不会出现角色滑行的结果。

<div align=center>
<img src="https://i.imgur.com/RzuZvJ5.png" width="80%">
</div>

## Blend Space

### 2D Blend Space

上面介绍的动画混合技术主要针对的是角色一维运动，我们可以基于同样的思想把角色在平面上的运动动画进行混合，进而获得角色不同方向上的连续动画。

<div align=center>
<img src="https://i.imgur.com/BPFBwXn.png" width="80%">
</div>

对骨骼动画进行插值的方法也很简单，只要根据角色运动的状态在两个方向上分别进行线性插值即可。

<div align=center>
<img src="https://i.imgur.com/sCOa7HX.png" width="80%">
</div>

有时动画师会为角色的平面运动建立多个不同的预设clip，在这种情况下直接进行插值是比较困难的。为了解决这种问题我们可以利用Delaunay三角化的方式对平面进行划分，在需要对动作进行插值时首先选择动作所在的三角形，然后再利用重心坐标进行插值即可。

<div align=center>
<img src="https://i.imgur.com/sdSZd48.png" width="80%">
</div>

### Skeleton Masked Blending

除了平面运动外，有些角色的动作可能只依赖于一部分骨骼。以鼓掌动作为例，角色在鼓掌时只涉及上半身的骨骼运动而与下半身无关，因此我们可以把上半身鼓掌的动作融合到其它下半身动作中。

<div align=center>
<img src="https://i.imgur.com/77QoSO1.png" width="80%">
</div>

要进行这样的处理也十分简单，我们也有设置一个mask来标记混合动画时需要考虑角色的哪些骨骼。这样就可以单独录制不同的动作然后根据需要组合出新的动作。

<div align=center>
<img src="https://i.imgur.com/MK5DQ43.png" width="80%">
<img src="https://i.imgur.com/LY3POsr.png" width="80%">
</div>

### Additive Blending

角色动作另一种常见的情况是动作本身只与关节相对姿态有关，而与绝对姿态无关。以点头动画为例，角色在点头时可以有不同的朝向，但在录制动画时只需要一套统一的动画。要处理这种情况则需要在保存动画时指明这个clip是只依赖于相对位姿的动画，在实际进行动画混合时再根据角色当前的姿态叠加上相对位姿。

<div align=center>
<img src="https://i.imgur.com/6PKc2ZA.png" width="80%">
<img src="https://i.imgur.com/YQk7Qot.png" width="80%">
</div>

使用这种additive blending技术时需要额外注意角色的姿态，尤其要避免角色关节的姿态超过最大值的情况。

<div align=center>
<img src="https://i.imgur.com/5wmlfqV.png" width="80%">
</div>

<div align=center>
<img src="https://i.imgur.com/KENrnfM.png" width="80%">
</div>

## Action State Machine (ASM)

在很多时候角色的动作不能直接通过对动画进行插值来获得。以跳跃为例，实际上角色的跳跃动作可以划分为起跳、浮空以及落地三个不同状态。不同的状态之间存在着一定的依赖关系，这会使得我们可能无法通过直接插值的方式来计算角色当前的动作。

<div align=center>
<img src="https://i.imgur.com/6J8RXYA.png" width="80%">
</div>

实际上我们可以把角色的动作和状态视为图上的节点，这样角色的运动就等价于在不同节点之间进行游走。这种模型称为**动作状态机(action state machine, ASM)**。

<div align=center>
<img src="https://i.imgur.com/2JnJiPS.png" width="80%">
</div>

当玩家发出指令后，角色根据指令和预设的状态转移条件来判断是否需要转移到其它的状态。当确定需要发生转移时就可以根据动画师的设计来切换角色的动画。

<div align=center>
<img src="https://i.imgur.com/THpAOuS.png" width="80%">
</div>

在切换角色动画时根据切换的方法可以分为smooth transition和frozen transition两种。进行smooth transition时，我们需要使用前面介绍过的动画混合插值方法逐步从一个动画过渡到另一个动画；而需要进行frozen transition时，我们则会停住角色当前的动画然后根据设置直接切换到下一个动画。这两种动画切换形式在游戏工业中都有广泛的应用。

<div align=center>
<img src="https://i.imgur.com/V4LvPxf.png" width="80%">
</div>

同时，在进行smooth transition时可以根据动画师的需要设计不同的过渡曲线来表达不同的动画切换效果。

<div align=center>
<img src="https://i.imgur.com/KYqiday.png" width="80%">
</div>

目前，动作状态机技术已经广泛应用于各种游戏引擎中。虚幻引擎中就实现了ASM来运行游戏开发者自定义角色的动画状态和切换条件。

<div align=center>
<img src="https://i.imgur.com/qVSa5dL.png" width="80%">
</div>

同时在游戏业界还结合了多层次的设计将角色身体的不同部位单独设计成状态机，这样可以实现更加丰富的角色动作。

<div align=center>
<img src="https://i.imgur.com/MduTu8H.png" width="80%">
</div>

## Animation Blend Tree

## Inverse Kinematics (IK)

## Facial Animation

## Animation Retargeting

## Reference

- [Lecture 09：Advanced Animation Technology](https://www.bilibili.com/video/BV1pY411F7pA)