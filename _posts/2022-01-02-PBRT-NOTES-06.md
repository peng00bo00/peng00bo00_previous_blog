---
layout: article
title: PBRT读书笔记06-Materials
tags: ["PBRT", "Rendering", "CG"]
key: PBRT-06
aside:
  toc: true
sidebar:
  nav: PBRT
---

> 这个系列是[Physically Based Rendering: From Theory To Implementation](https://pbr-book.org/)的读书笔记，本节主要介绍PBRT中的材质。
<!--more-->

## BSDFs

在PBRT中使用`BSDF`类来代表BRDF和BTDF，这样整个渲染器的其它部件可以直接调用`BSDF`类而不是分别考虑BRDF和BTDF两种情况。还需要说明的是PBRT在渲染时会区分几何法线$\mathbf{n}_g$和着色法线$\mathbf{n}_s$：几何法线是指由几何体表面所定义的法线，而着色法线则是由顶点法线或是凹凸贴图来定义。

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Materials/Geometric%20normal%20shading%20normal.svg" width="30%">
</div>

在`BSDF`类的实现中还需要存储有限个`BxDF`对象用来表示不同的散射模型，默认最多存储`8`个`BxDF`。添加`BxDF`对象需要调用`Add()`函数并提供相应的指针：

```cpp
void Add(BxDF *b) {
    Assert(nBxDFs < MaxBxDFs);
    bxdfs[nBxDFs++] = b;
}
```

由于`BxDF`在计算着色的时需要使用的着色坐标系，`BSDF`类中也因此需要提供世界坐标系到着色坐标系的变换公式。在[Geometric Setting](/2021/12/29/PBRT-NOTES-05.html#geometric-setting)中我们介绍过可以通过三个正交的方向向量$(\mathbf{s}, \mathbf{t}, \mathbf{n})$来定义着色坐标系，这样世界坐标系到着色坐标系的变换矩阵为：

$$
\mathbf{M} = 
\begin{bmatrix}
s_x & s_y & s_z \\
t_x & t_y & t_z \\
n_x & n_y & n_z \\
\end{bmatrix}
=
\begin{bmatrix}
\mathbf{s} \\ \mathbf{t} \\ \mathbf{n}
\end{bmatrix}
$$

由于变换矩阵$\mathbf{M}$是一个正交矩阵，着色坐标系到世界坐标系的变换矩阵为$\mathbf{M}^T$。

在渲染时着色法线可能会导致一些问题，比如说**漏光(light leak)**和**黑点(dark spot)**：漏光是指入射光线在几何法线以下，但对于着色法线仍然是可见的；而黑点则是指入射光线对几何法线是可见的，但由于它在着色法线以下而不会计算着色。

<div align=center>
<img src="https://pbr-book.org/3ed-2018/Materials/Shading%20normal%20errors.svg" width="80%">
</div>

为了解决这样的问题，在PBRT中在计算着色时同时使用了两个法线：如果$\omega_i$和$\omega_o$都位于几何法线$\mathbf{n}_g$的同一个半球上则计算BRDF，否则计算BTDF；而在计算散射函数时则使用着色法线$\mathbf{n}_s$进行计算。

对于给定的入射和出射方向，`BSDF`类会调用自身的`f()`函数来计算反射光线的radiance：

```cpp
Spectrum BSDF::f(const Vector3f &woW, const Vector3f &wiW, 
                 BxDFType flags) const {
    Vector3f wi = WorldToLocal(wiW), wo = WorldToLocal(woW);
    bool reflect = Dot(wiW, ng) * Dot(woW, ng) > 0;
    Spectrum f(0.f);
    for (int i = 0; i < nBxDFs; ++i)
        if (bxdfs[i]->MatchesFlags(flags) &&
            ((reflect && (bxdfs[i]->type & BSDF_REFLECTION)) ||
            (!reflect && (bxdfs[i]->type & BSDF_TRANSMISSION))))
            f += bxdfs[i]->f(wo, wi);
    return f;
}
```

## Material Interface and Implementations

### Matte Material

### Plastic Material

### Mix Material

### Fourier Material

### Additional Materials

## Bump Mapping

## Reference

- [9 Materials](https://pbr-book.org/3ed-2018/Materials)