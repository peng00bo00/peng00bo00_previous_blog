---
layout: article
title: GAMES104课程笔记05-Lighting, Materials and Shaders
tags: ["GAMES104", "CG"]
key: GAMES104-05
aside:
  toc: true
sidebar:
  nav: GAMES104
---

> 这个系列是GAMES104-现代游戏引擎：从入门到实践([GAMES 104: Modern Game Engine-Theory and Practice](https://games104.boomingtech.com/en/))的同步课程笔记。本课程会介绍现代游戏引擎所涉及的系统架构、技术点以及引擎系统相关的知识。本节课主要介绍现代游戏引擎的实时渲染算法。
<!--more-->

在上一节课中我们介绍了渲染的概念，而本节课我们则会开始介绍游戏引擎中具体的渲染算法。渲染是研究光与材质相互作用的学科，因此本节课从光线、材质以及shader三个方面介绍现代游戏引擎中各种经典实时算法的实现。

<div align=center>
<img src="https://i.imgur.com/ev8jRMf.png" width="80%">
</div>

## The Rendering Equation

渲染的本质是求解**渲染方程(the rendering equation)**，它由James Kajiya于1986年提出。

<div align=center>
<img src="https://i.imgur.com/komPRjJ.png" width="80%">
</div>

不严格地讲，渲染方程指出空间点$x$在方向$\omega_o$上出射的能量等于它自身在该方向发射的能量加上来自半球面上所有方向入射并经过反射后反射到$\omega_o$上的能量之和。

<div align=center>
<img src="https://i.imgur.com/OybsJIM.png" width="80%">
</div>

### Complexity of Real Rendering

显然想要直接求解渲染方程是相当困难的。在现实的场景中光线会在物体表面经过多次反射，同时不同的材质也有着天差地别的反射行为。

<div align=center>
<img src="https://i.imgur.com/4DmIPlp.png" width="80%">
</div>

渲染的难点之一在于阴影，或者说是光的可见性。如何做出合适的阴影效果远比想象中要难得多，在实践中往往需要通过大量的技巧才能实现符合人认知的阴影效果。

<div align=center>
<img src="https://i.imgur.com/73c8jwW.png" width="80%">
</div>

其次，场景中往往有着各种类型的光源需要考虑。常见的光源形式包括平行光、点光源、聚光灯、面光源等等。

<div align=center>
<img src="https://i.imgur.com/YVnO16j.png" width="80%">
</div>

材质是渲染中最为复杂的因素之一。如何设计符合现实世界的材质模型并且满足实时计算的要求是实时渲染的一大难点。

<div align=center>
<img src="https://i.imgur.com/79RC5lh.png" width="80%">
</div>

最后，在渲染时需要考虑光线在场景中不断反射的行为。全局光照一直是渲染的终极目标。

<div align=center>
<img src="https://i.imgur.com/Ll9aKjG.png" width="80%">
</div>

总结一下，渲染的难点可以分为一下三部分：如何计算入射光线、如何考虑材质以及如何实现全局光照。

<div align=center>
<img src="https://i.imgur.com/JwPhYP0.png" width="80%">
</div>

## Starting from Simple

### Simple Light Solution

我们从最简单的情况开始考虑。首先考虑对光照进行分解，将反射光分解为漫反射和环境光两部分。这样已经可以实现一些简单的渲染效果。

<div align=center>
<img src="https://i.imgur.com/AqcuxeH.png" width="80%">
</div>

为了更好地模拟环境光照，我们可以使用环境贴图技术把环境光存储在一个立方体表面上。这样当需要计算入射光线时只要根据方向去进行查询即可。

<div align=center>
<img src="https://i.imgur.com/Fk3VWxZ.png" width="80%">
</div>

实际上这样的处理方法在数学上也是解释得通的，它相当于把入射光线分解为低频的漫反射和高频的环境光。

<div align=center>
<img src="https://i.imgur.com/IMmHWhk.png" width="80%">
</div>

### Blinn-Phong Materials

有了光照后我们开始考虑材质。最经典的材质模型是**Blinn-Phong材质(Blinn-Phong materials)**，它把材质的反射行为分解为与方向无关的环境光、与入射和观察角度有关的漫反射以及高光。

<div align=center>
<img src="https://i.imgur.com/EUtEQp3.png" width="80%">
</div>

当然Blinn-Phong模型也有很多问题，比如说它不遵循能量守恒，同时它也不能描述现实世界中丰富的材质。

<div align=center>
<img src="https://i.imgur.com/OyYusoL.png" width="80%">
</div>

### Shadow

对于阴影问题，早期的处理方法主要是shadow volume，而现代游戏引擎的主流方法则是shadow map。shadow map的处理流程是在光源位置设置一个新的相机并渲染出一张深度图，然后在实际相机进行渲染时对每个点检测它到光源处的深度。如果该深度大于深度图对应位置处的深度则说明该点对于光源是不可见的，即位于阴影中。

<div align=center>
<img src="https://i.imgur.com/fQBx9aM.png" width="80%">
<img src="https://i.imgur.com/p6LbVZQ.png" width="80%">
</div>

shadow map的主要缺陷在于它只能产生"硬阴影"而无法产生现实中渐变的"软阴影"。而且从光源和相机进行采样时往往会使用不同的采样率，这容易导致各种走样和自遮挡的问题。

<div align=center>
<img src="https://i.imgur.com/T1MPNGr.png" width="80%">
</div>

把上面介绍过的这些技巧组合到一起并且配合美术的精巧设计就可以实现一些不错的渲染效果了。

<div align=center>
<img src="https://i.imgur.com/sMeZU09.png" width="80%">
<img src="https://i.imgur.com/Ai6AoHh.png" width="80%">
</div>

## Pre-computed Global Illumination.

## Physical-Based Material

## Image-Based Lighting

## Classic Shadow Solution

## Moving Wave of High Quality

## Shader Management

## Reference

- [Lecture 05：Rendering on Game Engine](https://www.bilibili.com/video/BV1J3411n7WT)
- [GAMES202 Lecture 03：Real-time Shadows 1](https://www.bilibili.com/video/BV1YK4y1T7yY?p=3)
- [GAMES202 Lecture 04：Real-time Shadows 2](https://www.bilibili.com/video/BV1YK4y1T7yY?p=4)