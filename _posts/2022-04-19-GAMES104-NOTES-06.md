---
layout: article
title: GAMES104课程笔记06-The Challenges and Fun of Rendering the Beautiful Mother Nature
tags: ["GAMES104", "CG"]
key: GAMES104-06
aside:
  toc: true
sidebar:
  nav: GAMES104
---

> 这个系列是GAMES104-现代游戏引擎：从入门到实践([GAMES 104: Modern Game Engine-Theory and Practice](https://games104.boomingtech.com/en/))的同步课程笔记。本课程会介绍现代游戏引擎所涉及的系统架构、技术点以及引擎系统相关的知识。本节课主要介绍现代游戏引擎中的地形和大气渲染技术。
<!--more-->

现实世界中有着丰富的自然场景，如果只使用简单的绘制程序则很难给予玩家真实的游戏体验。因此在本节课中我们会介绍3A游戏中使用的自然场景渲染技术。

<div align=center>
<img src="https://i.imgur.com/jDU9UTs.png" width="80%">
<img src="https://i.imgur.com/kyjqMAi.png" width="80%">
</div>

## Landscape

目前的3A游戏中以及可以生成逼真的地形环境渲染效果。以微软的模拟飞行为例，最新一代的模拟飞行已经基本实现了真实地球的地貌绘制，此外基于地形绘制技术我们也可以生成其它星球的地形和地貌。

<div align=center>
<img src="https://i.imgur.com/WvpUiNj.png" width="80%">
<img src="https://i.imgur.com/4RBc4Bg.png" width="80%">
</div>

### Terrain Geometry

#### Heightfield

表示地形最简单的方法是使用**高度场(heightfield)**。我们可以把地形看做是平面上具有不同高度的函数，然后通过在平面进行均匀采样来近似它。这种方法在遥感等领域仍然有着很多的应用。

<div align=center>
<img src="https://i.imgur.com/BUMI1bU.png" width="80%">
</div>

高度场的缺陷在于当我们需要表示大规模的地形或者需要更精细的地形时所需的采样点数会成倍的增长。

<div align=center>
<img src="https://i.imgur.com/8ipmMFn.png" width="80%">
</div>

在游戏引擎中由于玩家观察的**视野(field of view, FOV)**是有限的，实际上我们不需要对所有的网格进行加密采样，只需关注视野中的地形即可。在这种思想下人们提出了两条加密采样原则：首先是根据距离和视野来调整网格的疏密，对于不再视野范围内或是距离观察点比较遥远位置的地形无需使用加密的网格；另一条是在对地形进行采样时要考虑对网格进行加密或者化简后地形高度的误差不要超过一定的范围，我们希望近处地形的误差尽可能小而远处的误差可以大一些。

<div align=center>
<img src="https://i.imgur.com/yrCAWyn.png" width="80%">
<img src="https://i.imgur.com/cvS6LlC.png" width="80%">
</div>

对三角网格进行加密可以通过三角网剖分算法来实现。对于均匀分布的网格，其中每个三角形都是等腰直角三角形。因此在进行剖分时可以直接选择三角形的斜边中点将它剖分成两个一样的小等腰直角三角形。显然这样的剖分方法等价于为二叉树添加叶节点。

<div align=center>
<img src="https://i.imgur.com/g4B0POh.png" width="80%">
</div>

在进行剖分时还需要注意**T-junction**的问题：当我们对某个三角形进行剖分后必须同时将与它具有相同邻边的三角形同时进行剖分，否则会有顶点落在其它三角形的边上。

<div align=center>
<img src="https://i.imgur.com/7OcPIHA.png" width="80%">
</div>

利用现代GPU的计算性能和上面介绍的三角剖分算法就可以实现大规模场景地形的实时渲染。

<div align=center>
<img src="https://i.imgur.com/FQjh3Cn.png" width="80%">
</div>

当然在游戏行业中更常用的高度场表达方式是使用四叉树来表达地形。这种方法更符合人的直觉，同时也可以直接使用纹理的存储方式来存储这种四叉树的结构。

<div align=center>
<img src="https://i.imgur.com/W7maqBa.png" width="80%">
<img src="https://i.imgur.com/Ow3FGeY.png" width="80%">
</div>

quad-tree同样需要考虑T-junction的问题。不过在quad-tree中可以通过将三角形顶点之间吸附到其它顶点上的方法来简化处理。

<div align=center>
<img src="https://i.imgur.com/6C9QOZn.png" width="80%">
</div>

#### Triangulated Irregular Network

在很多场景中均匀采样的地形会造成一些存储空间的浪费。实际上对于高度变化不大的区域只需要少量的三角形就可以进行表达，而对于高程变化剧烈的区域使用数量更多的三角形来还原地形的细节。

<div align=center>
<img src="https://i.imgur.com/FJZUHMc.png" width="80%">
</div>

不过目前这样的方法在游戏工业界的应用还比较少，主流的地形处理方法仍然是使用均匀采样的网格。

<div align=center>
<img src="https://i.imgur.com/YMiJrPI.png" width="80%">
</div>

#### Hardware Tessellation

利用现代GPU的强大计算能力我们可以把地形的细化完全放到GPU上进行实时计算。在DirectX 11中提供了hull shader、tessellator以及domain shader等工具来网格的实时细分。

<div align=center>
<img src="https://i.imgur.com/9VS9DOk.png" width="80%">
<img src="https://i.imgur.com/FXYNtPt.png" width="80%">
</div>

在更新的DirectX 12中则将这些概念合并到mesh shader中，通过mesh shader来实现全部的网格细分功能，从而极大地方便来游戏开发和图形程序。

<div align=center>
<img src="https://i.imgur.com/E9qJF6L.png" width="80%">
</div>

此外还可以利用GPU的计算性能实现动态的地形绘制，从而进一步提升玩家的游戏体验。

<div align=center>
<img src="https://i.imgur.com/6bk1Rza.png" width="80%">
</div>

#### Non-Heightfield Terrain

有些游戏场景如洞穴可能无法使用高度场来进行表示。

<div align=center>
<img src="https://i.imgur.com/a2fkexF.png" width="80%">
</div>

对于这种场景可以考虑使用体素来表达场景的几何，然后利用marching cube算法来生成表面。

<div align=center>
<img src="https://i.imgur.com/kLhqRWJ.png" width="80%">
<img src="https://i.imgur.com/4YlsCTZ.png" width="80%">
</div>

当然这种方法目前仍处于试验阶段，几乎没有游戏使用相关的技术来表示地形。

<div align=center>
<img src="https://i.imgur.com/BJ5seF5.png" width="80%">
</div>

### Terrain Texture

## Reference

- [Lecture 06：Rendering on Game Engine I](https://www.bilibili.com/video/BV1au411y7Fq)